{% extends 'barrister/barrister-base.html' %}
{% load static %}


{% block title %}
<title>Musteriler</title>
{% endblock title %}

{% block links %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/style2.css' %}">
<style>
  .container {
    max-width: 1170px;
    margin: auto;
  }

  img {
    max-width: 100%;
  }

  .inbox_people {
    background: #f8f8f8 none repeat scroll 0 0;
    float: left;
    overflow: hidden;
    width: 40%;
    border-right: 1px solid #c4c4c4;
  }

  .inbox_msg {
    border: 1px solid #c4c4c4;
    clear: both;
    overflow: hidden;
  }

  .top_spac {
    margin: 20px 0 0;
  }


  .recent_heading {
    float: left;
    width: 40%;
  }

  .srch_bar {
    display: inline-block;
    text-align: right;
    width: 60%;
  }

  .headind_srch {
    padding: 10px 29px 10px 20px;
    overflow: hidden;
    border-bottom: 1px solid #c4c4c4;
  }

  .recent_heading h4 {
    color: #05728f;
    font-size: 21px;
    margin: auto;
  }

  .srch_bar input {
    border: 1px solid #cdcdcd;
    border-width: 0 0 1px 0;
    width: 80%;
    padding: 2px 0 4px 6px;
    background: none;
  }

  .srch_bar .input-group-addon button {
    background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
    border: medium none;
    padding: 0;
    color: #707070;
    font-size: 18px;
  }

  .srch_bar .input-group-addon {
    margin: 0 0 0 -27px;
  }

  .chat_ib h5 {
    font-size: 15px;
    color: #464646;
    margin: 0 0 8px 0;
  }

  .chat_ib h5 span {
    font-size: 13px;
    float: right;
  }

  .chat_ib p {
    font-size: 14px;
    color: #989898;
    margin: auto
  }

  .chat_img {
    float: left;
    width: 11%;
  }

  .chat_ib {
    float: left;
    padding: 0 0 0 15px;
    width: 88%;
  }

  .chat_people {
    overflow: hidden;
    clear: both;
  }

  .chat_list {
    border-bottom: 1px solid #c4c4c4;
    margin: 0;
    padding: 18px 16px 10px;
  }

  .inbox_chat {
    height: 550px;
    overflow-y: scroll;
  }

  .active_chat {
    background: #ebebeb;
  }

  .incoming_msg_img {
    display: inline-block;
    width: 6%;
  }

  .received_msg {
    display: inline-block;
    padding: 0 0 0 10px;
    vertical-align: top;
    width: 92%;
  }

  .received_withd_msg p {
    background: #ebebeb none repeat scroll 0 0;
    border-radius: 3px;
    color: #646464;
    font-size: 14px;
    margin: 0;
    padding: 5px 10px 5px 12px;
    width: 100%;
  }

  .time_date {
    color: #747474;
    display: block;
    font-size: 12px;
    margin: 8px 0 0;
  }

  .received_withd_msg {
    width: 57%;
  }

  .mesgs {
    float: left;
    padding: 30px 15px 0 25px;
    width: 100%;
  }

  .sent_msg p {
    background: #05728f none repeat scroll 0 0;
    border-radius: 3px;
    font-size: 14px;
    margin: 0;
    color: #fff;
    padding: 5px 10px 5px 12px;
    width: 100%;
  }

  .outgoing_msg {
    overflow: hidden;
    margin: 26px 0 26px;
  }

  .sent_msg {
    float: right;
    width: 46%;
  }

  .input_msg_write input {
    background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
    border: medium none;
    color: #4c4c4c;
    font-size: 15px;
    min-height: 48px;
    width: 100%;
  }

  .type_msg {
    border-top: 1px solid #c4c4c4;
    position: relative;
  }

  .msg_send_btn {
    background: #05728f none repeat scroll 0 0;
    border: medium none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    font-size: 17px;
    height: 33px;
    position: absolute;
    right: 0;
    top: 11px;
    width: 33px;
  }

  .messaging {
    padding: 0 0 50px 0;
  }

  .msg_history {
    height: 516px;
    overflow-y: auto;
  }
</style>
{% endblock links %}


{% block content %}
<main class="page-content design">
  <!-- https://codepen.io/themustafaomar/pen/jLMPKm -->
  <div class="container-fluid clients-content">
    <div class="row mr-0">
      <div class="col-12 header">
        <span>Müştərilər</span>
      </div>

      <div class="col-12  my-2">
        <div class="container">
          <!-- <h3 class=" text-center">Messaging</h3> -->
          <div class="messaging">
            <div class="inbox_msg">
              <!-- <div class="inbox_people">
                <div class="headind_srch">
                  <div class="recent_heading">
                    <h4>Recent</h4>
                  </div>
                  <div class="srch_bar">
                    <div class="stylish-input-group">
                      <input type="text" class="search-bar" placeholder="Search">
                      <span class="input-group-addon">
                        <button type="button"> <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                      </span> </div>
                  </div>
                </div>
                <div class="inbox_chat">
                  <div class="chat_list active_chat">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                  <div class="chat_list">
                    <div class="chat_people">
                      <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil">
                      </div>
                      <div class="chat_ib">
                        <h5>Sunil Rajput <span class="chat_date">Dec 25</span></h5>
                        <p>Test, which is a new approach to have all solutions
                          astrology under one roof.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div> -->
              <div class="mesgs">
                <div class="msg_history">
                  {% for message in messages %}
                  {% if message.sender == request.user %}
                  <div class="outgoing_msg">
                    <div class="sent_msg">
                      {% if message.attachment %}
                      <p><a href="{{message.attachment.file.url}}">{{message.attachment.name}}</a></p>
                      {% endif %}
                      <p>{{message.text}}</p>
                      <span class="time_date">{{message.date}}</span>
                    </div>
                  </div>
                  {% else %}
                  <div class="incoming_msg">
                    <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png"
                        alt="sunil">
                    </div>
                    <div class="received_msg">
                      <div class="received_withd_msg">
                        {% if message.attachment %}
                        <p><a href="{{message.attachment.file.url}}">{{message.attachment.name}}</a></p>
                        {% endif %}
                        <p>{{message.text}}</p>
                        <span class="time_date">{{message.date}}</span>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                </div>
                <div class="type_msg">
                  <div class="input_msg_write">
                    <input type="text" class="write_msg" id="chat-message-input" placeholder="Type a message" />
                    <button class="msg_send_btn" id="chat-message-submit" type="button"><i class="fa fa-paper-plane-o"
                        aria-hidden="true"></i></button>
                    <input type="file" id="input_file">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</main>

{% endblock content %}


{% block scripts %}
<script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script src="{% static 'js/owl.carousel.min.js' %}"></script>
<script src="{% static 'vendor/fullcalendar-3.10.0/lib/moment.min.js' %}"></script>
<script src="{% static 'vendor/fullcalendar-3.10.0/lib/jquery.min.js' %}"></script>
<script src="{% static 'vendor/fullcalendar-3.10.0/fullcalendar.min.js' %}"></script>
<script src="{% static 'vendor/fullcalendar-3.10.0/locale/az.js' %}"></script>
<script src="{% static 'js/fullcalendar.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>

<script>
  var roomName = '{{ room_name }}';
  var current_user = '{{request.user.id}}'

  var chatSocket = new WebSocket(
    'ws://' + window.location.host +
    '/ws/chat/' + roomName + '/');


  var load_data = function (index) {
    var end = index + 1000000;
    if (index >= this.file.size) return;
    if (end > this.file.size) end = this.file.size;

    var reader = new FileReader();
    reader.onload = function () {
      var content = reader.result;
      console.log(end / 1000000)
      content = btoa(content)
      chatSocket.send(JSON.stringify({
        'message': '',
        'type': 'file',
        'action': 'progress',
        'data': content
      }));
    };
    reader.readAsBinaryString(this.file.slice(index, end));

  }.bind(this);


  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = jQuery.trim(cookies[i]);
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }


  function uploadProgressHandler(event) {
    var percent = (event.loaded / event.total) * 100;
    var progress = Math.round(percent);
    console.log(progress)
    // $("#loaded_n_total").html("Uploaded " + event.loaded + " bytes of " + event.total);
    // var percent = (event.loaded / event.total) * 100;
    // var progress = Math.round(percent);
    // $("#uploadProgressBar").html(progress + " percent na ang progress");
    // $("#uploadProgressBar").css("width", progress + "%");
    // $("#status").html(progress + "% uploaded... please wait");
  }

  function loadHandler(event) {
    // $("#status").html(event.target.responseText);
    // $("#uploadProgressBar").css("width", "0%");
  }

  function errorHandler(event) {
    // $("#status").html("Upload Failed");
  }

  function abortHandler(event) {
    // $("#status").html("Upload Aborted");
  }

  $("#input_file").change(function () {
    file = $("#input_file").get(0).files[0];
    this.file = file;
    console.log(file);

    var formData = new FormData();
    formData.append('file', file);
    // const data_ = JSON.stringify(data)
    // formData.append('data', data);

    $.ajax({
      type: 'POST',
      url: '/chat/upload_file/{{receiver}}/',
      headers: { "X-CSRFToken": getCookie('csrftoken') },
      contentType: false,
      processData: false,
      data: formData,
      xhr: function () {
        var xhr = new window.XMLHttpRequest();
        xhr.upload.addEventListener("progress",
          uploadProgressHandler,
          false
        );
        xhr.addEventListener("load", loadHandler, false);
        xhr.addEventListener("error", errorHandler, false);
        xhr.addEventListener("abort", abortHandler, false);

        return xhr;
      },
      success: function (data) {
        chatSocket.send(JSON.stringify({
          'type': 'file',
          'action': 'post',
          'id': data.id,
          'message': data.message,
          'filename': data.filename,
          'url': data.url,
          'date': data.date,
        }))
      },
      error: function (jqXhr, textStatus, errorMessage) {
        alert(errorMessage)
      }
    });
    // chatSocket.send(JSON.stringify({
    //   'message': '',
    //   'type': 'file',
    //   'file_name': file.name,
    //   'file_size': file.size,
    //   'action': 'prepare',
    // }));
  });

  chatSocket.onmessage = function (e) {
    var data = JSON.parse(e.data);
    console.log(data)

    if (data.type == 'text' && data.action == "post") {
      if (data.sender == current_user) {
        document.querySelector('.msg_history').innerHTML += (
          "<div class='outgoing_msg'>" +
          "<div class='sent_msg'>" +
          "<p>" + data.message + "</p>" +
          "<span class='time_date'>" + data.date + "</span>" +
          "</div>" +
          "</div>"
        )
      } else {
        document.querySelector('.msg_history').innerHTML += (
          "<div class='incoming_msg'>" +
          "<div class='incoming_msg_img'><img src='https://ptetutorials.com/images/user-profile.png' alt='sunil'></div>" +
          "<div class='received_msg'>" +
          "<div class='received_withd_msg'>" +
          "<p>" + data.message + "</p>" +
          "<span class='time_date'>" + data.date + "</span>" +
          "</div>" +
          "</div>" +
          "</div>"
        );
      }
    }
    else if (data.type == 'file') {
      // if (data.action == 'progress') {
      //   load_data(data.file_size);
      // }
      // else if (data.action == "complete") {
      // 
      // }
      if (data.action == "post") {
        if (data.sender == current_user) {
          document.querySelector('.msg_history').innerHTML += (
            "<div class='outgoing_msg'>" +
            "<div class='sent_msg'>" +
            "<p><a href='" + data.url + "'>" + data.filename + "</a></p>" +
            "<p>" + data.message + "</p>" +
            "<span class='time_date'>" + data.date + "</span>" +
            "</div>" +
            "</div>"
          )
        } else {
          document.querySelector('.msg_history').innerHTML += (
            "<div class='incoming_msg'>" +
            "<div class='incoming_msg_img'><img src='https://ptetutorials.com/images/user-profile.png' alt='sunil'></div>" +
            "<div class='received_msg'>" +
            "<div class='received_withd_msg'>" +
            "<p><a href='" + data.file_link + "'>" + data.filename + "</a></p>" +
            "<p>" + data.message + "</p>" +
            "<span class='time_date'>" + data.date + "</span>" +
            "</div>" +
            "</div>" +
            "</div>"
          );
        }
      }
    }

  };

  chatSocket.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function (e) {
    if (e.keyCode === 13) {  // enter, return
      document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function (e) {
    var messageInputDom = document.querySelector('#chat-message-input');
    var message = messageInputDom.value;
    chatSocket.send(JSON.stringify({
      'message': message,
      'type': 'text',
      'action': 'post'
    }));

    messageInputDom.value = '';
  };
</script>
{% endblock scripts %}